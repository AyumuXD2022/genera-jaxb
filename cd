package mx.com.backend.gateway_service.config;

import com.nimbusds.jose.RemoteKeySourceException;
import com.nimbusds.jose.jwk.JWK;
import com.nimbusds.jose.jwk.JWKSelector;
import com.nimbusds.jose.jwk.source.JWKSource;
import com.nimbusds.jose.jwk.source.RemoteJWKSet;
import com.nimbusds.jose.proc.SecurityContext;
import com.nimbusds.jose.proc.JWSKeySelector;
import com.nimbusds.jose.proc.JWSVerificationKeySelector;
import com.nimbusds.jose.JWSAlgorithm;
import com.nimbusds.jwt.proc.ConfigurableJWTProcessor;
import com.nimbusds.jwt.proc.DefaultJWTProcessor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.security.oauth2.jwt.JwtDecoder;
import org.springframework.security.oauth2.jwt.NimbusJwtDecoder;

import java.net.URL;
import java.util.List;

/**
 * ConfiguraciÃ³n de JwtDecoder con logging detallado
 * VERÃS LOGS CADA VEZ que llegue un token con diferente KID
 */
@Configuration
public class JwtDecoderWithKidLogging {
    
    private static final Logger log = LoggerFactory.getLogger(JwtDecoderWithKidLogging.class);
    
    @Value("${spring.security.oauth2.resourceserver.jwt.jwk-set-uri}")
    private String jwkSetUri;

    /**
     * JwtDecoder CON LOGGING - Este es el que se usarÃ¡
     * Muestra logs CADA VEZ que se valida un token
     */
    @Bean
    @Primary  // <-- IMPORTANTE: Marca este como el principal
    public JwtDecoder jwtDecoder() throws Exception {
        log.info("ğŸ”§ Configurando JwtDecoder con logging detallado");
        log.info("ğŸ“ JWK Set URI: {}", jwkSetUri);
        
        URL jwkSetUrl = new URL(jwkSetUri);
        
        // JWKSource personalizado que loguea CADA bÃºsqueda de llave
        JWKSource<SecurityContext> jwkSource = new RemoteJWKSet<SecurityContext>(jwkSetUrl) {
            
            private int requestCount = 0;
            
            @Override
            public List<JWK> get(JWKSelector jwkSelector, SecurityContext context) 
                    throws RemoteKeySourceException {
                
                requestCount++;
                
                log.info("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
                log.info("â•‘         ğŸ” BÃšSQUEDA DE LLAVE #{}                       â•‘", requestCount);
                log.info("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
                
                // Mostrar quÃ© KID se estÃ¡ buscando
                if (jwkSelector.getKeyIDs() != null && !jwkSelector.getKeyIDs().isEmpty()) {
                    log.info("â•‘ ğŸ¯ Token solicita KID: {}                    ", jwkSelector.getKeyIDs().iterator().next());
                } else {
                    log.warn("â•‘ âš ï¸  Token SIN KID especificado                         â•‘");
                }
                
                // Obtener las llaves que coinciden
                List<JWK> matchedKeys = super.get(jwkSelector, context);
                
                // Mostrar resultado
                if (matchedKeys.isEmpty()) {
                    log.error("â•‘ âŒ NO SE ENCONTRÃ“ la llave solicitada                  â•‘");
                    log.error("â•‘    El KID no existe en el JWK Set                      â•‘");
                } else {
                    for (JWK key : matchedKeys) {
                        log.info("â•‘ âœ… LLAVE ENCONTRADA:                                   â•‘");
                        log.info("â•‘    - KID: {}                          ", key.getKeyID());
                        log.info("â•‘    - Tipo: {}                                        ", key.getKeyType());
                        log.info("â•‘    - Algoritmo: {}                                   ", key.getAlgorithm());
                    }
                    log.info("â•‘ ğŸ“Œ Usando SOLO esta llave, ignorando las demÃ¡s         â•‘");
                }
                
                log.info("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
                
                return matchedKeys;
            }
        };
        
        // Configurar el processor
        ConfigurableJWTProcessor<SecurityContext> jwtProcessor = new DefaultJWTProcessor<>();
        
        // Configurar el selector de llaves con el algoritmo
        JWSKeySelector<SecurityContext> jwsKeySelector = 
            new JWSVerificationKeySelector<>(JWSAlgorithm.RS256, jwkSource);
        jwtProcessor.setJWSKeySelector(jwsKeySelector);
        
        // Crear el decoder
        NimbusJwtDecoder decoder = new NimbusJwtDecoder(jwtProcessor);
        
        log.info("âœ… JwtDecoder con logging configurado correctamente");
        log.info("ğŸ“ VerÃ¡s logs cada vez que llegue un token");
        
        return decoder;
    }
}
