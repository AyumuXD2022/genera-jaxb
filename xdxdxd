import java.sql.Connection;
import java.sql.DriverManager;
import java.util.Properties;

public class KerberosKeytabConnection {
    
    static {
        System.setProperty("java.security.auth.login.config", "/ruta/completa/jaas.conf");
        System.setProperty("java.security.krb5.conf", "/ruta/completa/krb5.conf");
        System.setProperty("javax.security.auth.useSubjectCredsOnly", "false");
        System.setProperty("sun.security.krb5.debug", "true");
    }
    
    public static void main(String[] args) {
        String hostname = "tu-hostname";
        String instance = "tu-instancia"; 
        String database = "tu-database";
        int port = 64441;
        
        // Construir URL con puerto específico
        String connectionUrl = String.format(
            "jdbc:sqlserver://%s:%d;instanceName=%s;databaseName=%s",
            hostname, port, instance, database
        );
        
        Properties props = new Properties();
        props.setProperty("integratedSecurity", "true");
        props.setProperty("authenticationScheme", "JavaKerberos");
        props.setProperty("serverSpn", "MSSQLSvc/" + hostname + ":" + port);
        props.setProperty("trustServerCertificate", "true");
        props.setProperty("loginTimeout", "30");
        
        try {
            Connection connection = DriverManager.getConnection(connectionUrl, props);
            System.out.println("✅ Conexión Kerberos exitosa en puerto " + port);
            
            var stmt = connection.createStatement();
            var rs = stmt.executeQuery("SELECT @@version as version");
            if (rs.next()) {
                System.out.println("SQL Server: " + rs.getString("version"));
            }
            
            connection.close();
        } catch (Exception e) {
            System.err.println("❌ Error de conexión: " + e.getMessage());
            e.printStackTrace();
        }
    }
}
